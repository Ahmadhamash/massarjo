<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المرشد | مسار</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind (نفس اللي في index) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- الخطوط والأيقونات -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- نفس ملف الستايل -->
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #020617;
      color: #e5e7eb;
    }
    .loading-spinner {
      border: 3px solid rgba(148, 163, 184, 0.3);
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- الهيدر -->
  <header class="w-full border-b border-slate-800 bg-slate-900/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span id="mentorAvatarCircle"
              class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-600 text-white font-bold">
          م
        </span>
        <div>
          <p class="text-xs text-slate-400">مرحباً</p>
          <p id="mentorName" class="font-bold text-lg">مرشد</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="logoutBtn" class="btn-secondary">
          <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
        </button>
        <a href="index.html" class="text-sm text-slate-400 hover:text-slate-100">
          رجوع إلى الصفحة الرئيسية
        </a>
      </div>
    </div>
  </header>

  <!-- المحتوى -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-extrabold mb-2">لوحة طلبات المرشد</h1>
    <p class="text-slate-400 mb-6">
      هنا يمكنك متابعة الطلبات التي تم تأكيدها من قبل الأدمن والتابعة لك فقط.
    </p>

    <!-- الفلاتر -->
    <div class="mb-6 flex flex-wrap gap-3">
      <button data-filter="all"
              class="filter-chip bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold">
        الكل
      </button>
      <button data-filter="confirmed"
              class="filter-chip bg-slate-800 text-slate-100 px-4 py-2 rounded-full text-sm">
        المؤكدة
      </button>
      <button data-filter="completed"
              class="filter-chip bg-slate-800 text-slate-100 px-4 py-2 rounded-full text-sm">
        المكتملة
      </button>
    </div>

    <!-- الطلبات -->
    <div id="mentorOrdersContainer" class="space-y-4">
      <div class="text-center py-10">
        <div class="loading-spinner mb-4"></div>
        <p class="text-slate-300">جاري تحميل الطلبات...</p>
      </div>
    </div>
  </main>

  <!-- سكربت المشروع الأساسي -->
  <script src="mind.js"></script>

  <!-- سكربت لوحة المرشد -->
  <script>
    (function () {
      let mentorOrders = [];

      const ordersContainer = document.getElementById('mentorOrdersContainer');
      const nameEl = document.getElementById('mentorName');
      const avatarEl = document.getElementById('mentorAvatarCircle');
      const logoutBtn = document.getElementById('logoutBtn');

      // تشغيل عند تحميل الصفحة
      document.addEventListener('DOMContentLoaded', initMentorDashboard);

      async function initMentorDashboard() {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            window.location.href = 'index.html';
            return;
          }

          // 1) جلب بيانات المستخدم الحالي
          const meRes = await fetch(API_BASE_URL + '/auth/me', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });

          const meData = await meRes.json();

          if (!meData.success || !meData.user || meData.user.role !== 'mentor') {
            // مش مرشد → رجوع للصفحة الرئيسية
            window.location.href = 'index.html';
            return;
          }

          const user = meData.user;
          nameEl.textContent = user.name || 'مرشد';
          avatarEl.textContent = (user.name && user.name[0]) ? user.name[0].toUpperCase() : 'م';

          // 2) جلب الطلبات
          await loadMentorOrders();

        } catch (err) {
          console.error('Error in initMentorDashboard:', err);
          if (typeof showNotification === 'function') {
            showNotification('حدث خطأ أثناء تحميل البيانات', 'error');
          }
          ordersContainer.innerHTML =
            '<p class="text-center text-red-400 py-8">خطأ في تحميل البيانات.</p>';
        }
      }

      async function loadMentorOrders() {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = 'index.html';
          return;
        }

        ordersContainer.innerHTML =
          '<div class="text-center py-10"><div class="loading-spinner mb-4"></div><p class="text-slate-300">جاري تحميل الطلبات...</p></div>';

        try {
          const res = await fetch(API_BASE_URL + '/orders/mentor/my-orders', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });

          const data = await res.json();

          if (!data.success) {
            ordersContainer.innerHTML =
              '<p class="text-center text-red-400 py-8">فشل في تحميل الطلبات.</p>';
            return;
          }

          mentorOrders = data.orders || [];
          renderMentorOrders('all');

        } catch (err) {
          console.error('Error loading mentor orders:', err);
          ordersContainer.innerHTML =
            '<p class="text-center text-red-400 py-8">خطأ في الاتصال بالسيرفر.</p>';
        }
      }

      function renderMentorOrders(filterStatus) {
        let filtered = mentorOrders;
        if (filterStatus !== 'all') {
          filtered = mentorOrders.filter(function (o) {
            return o.status === filterStatus;
          });
        }

        if (!filtered.length) {
          ordersContainer.innerHTML =
            '<div class="text-center py-12 bg-slate-800/60 rounded-xl border border-slate-700">' +
              '<i class="fas fa-inbox text-4xl text-slate-500 mb-3"></i>' +
              '<p class="text-slate-300">لا توجد طلبات في هذا القسم حالياً.</p>' +
            '</div>';
          return;
        }

        var html = '';
        filtered.forEach(function (order) {
          var createdAt = order.createdAt
            ? new Date(order.createdAt).toLocaleString('ar-SA')
            : 'غير معروف';

          var customerName =
            (order.user && order.user.name) ||
            (order.customerInfo && order.customerInfo.name) ||
            'مستخدم';

          var customerPhone =
            (order.user && order.user.phone) ||
            (order.customerInfo && order.customerInfo.phone) ||
            'غير متوفر';

          var packageName =
            (order.package && order.package.name) ||
            order.packageName ||
            'باقة غير محددة';

          var amount = order.totalAmount || order.packagePrice || 0;

          var status = order.status || 'pending';
          var paymentStatus = order.paymentStatus || 'pending';

          // لو موجودة الدوال من mind.js نستخدمها، وإلا نطبع القيمة نفسها
          var statusText = (typeof getOrderStatusText === 'function')
            ? getOrderStatusText(status)
            : status;

          var paymentText = (typeof getPaymentStatusText === 'function')
            ? getPaymentStatusText(paymentStatus)
            : paymentStatus;

          html +=
            '<div class="session-card">' +
              '<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">' +
                '<div class="flex-1">' +
                  '<div class="flex items-center gap-2 mb-1">' +
                    '<span class="status-badge status-' + status + ' text-xs">' + statusText + '</span>' +
                    '<span class="text-xs text-slate-500">#' + (order._id ? order._id.slice(-6) : '') + '</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-lg mb-1">' + packageName + '</h3>' +
                  '<p class="text-sm text-slate-300">' +
                    '<i class="fas fa-user ml-1"></i>' +
                    'العميل: <span class="text-indigo-300">' + customerName + '</span>' +
                  '</p>' +
                  '<p class="text-sm text-slate-400 mt-1">' +
                    '<i class="fas fa-phone ml-1"></i>' +
                    'الهاتف: ' + customerPhone +
                  '</p>' +
                '</div>' +

                '<div class="flex flex-col gap-1 text-sm text-slate-200 bg-slate-800/60 p-3 rounded-lg min-w-[220px]">' +
                  '<div class="flex items-center gap-2">' +
                    '<i class="fas fa-calendar-alt text-indigo-400 w-5 text-center"></i>' +
                    '<span>' + createdAt + '</span>' +
                  '</div>' +
                  '<div class="flex items-center gap-2">' +
                    '<i class="fas fa-money-bill-wave text-green-400 w-5 text-center"></i>' +
                    '<span>المبلغ: ' + amount + ' د.أ</span>' +
                  '</div>' +
                  '<div class="flex items-center gap-2">' +
                    '<i class="fas fa-receipt text-amber-400 w-5 text-center"></i>' +
                    '<span>حالة الدفع: ' + paymentText + '</span>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>';
        });

        ordersContainer.innerHTML = html;
      }

      // تغيير الفلاتر
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('filter-chip')) {
          var chips = document.querySelectorAll('.filter-chip');
          chips.forEach(function (ch) {
            ch.classList.remove('bg-indigo-600', 'text-white');
            ch.classList.add('bg-slate-800', 'text-slate-100');
          });

          e.target.classList.add('bg-indigo-600', 'text-white');
          e.target.classList.remove('bg-slate-800', 'text-slate-100');

          var filter = e.target.getAttribute('data-filter') || 'all';
          renderMentorOrders(filter);
        }
      });

      // تسجيل الخروج
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          if (typeof logout === 'function') {
            logout();
          } else {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
          }
        });
      }
    })();
  </script>
</body>
</html>
