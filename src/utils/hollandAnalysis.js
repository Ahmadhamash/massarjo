const OpenAI = require('openai');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

const hollandTypes = {
  R: "الواقعي (Realistic) - يحب العمل العملي والأنشطة الجسدية",
  I: "الاستقصائي (Investigative) - يحب البحث والتحليل والعلوم",
  A: "الفني (Artistic) - يحب الإبداع والتعبير الفني",
  S: "الاجتماعي (Social) - يحب مساعدة الآخرين والعمل معهم",
  E: "المغامر (Enterprising) - يحب القيادة والإقناع والمبادرة",
  C: "التقليدي (Conventional) - يحب التنظيم والعمل بالقواعد"
};

const generateHollandAnalysis = async (primaryType, secondaryType, scores) => {
  try {
    const prompt = `
    بناءً على نتائج مقياس هولاند للميول المهنية:
    
    النوع الأساسي: ${hollandTypes[primaryType]}
    النوع الثانوي: ${hollandTypes[secondaryType]}
    
    النتائج:
    - الواقعي (R): ${scores.R}/10
    - الاستقصائي (I): ${scores.I}/10  
    - الفني (A): ${scores.A}/10
    - الاجتماعي (S): ${scores.S}/10
    - المغامر (E): ${scores.E}/10
    - التقليدي (C): ${scores.C}/10

    قدم تحليلاً شاملاً باللغة العربية يتضمن:
    1. التخصصات الجامعية المناسبة (5-7 تخصصات)
    2. الوظائف المقترحة (5-7 وظائف)
    3. نصائح للنجاح (4-5 نصائح)

    قدم الإجابة بتنسيق JSON:
    {
      "majors": ["تخصص 1", "تخصص 2", ...],
      "careers": ["وظيفة 1", "وظيفة 2", ...],
      "tips": ["نصيحة 1", "نصيحة 2", ...]
    }
    `;

    const response = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: "أنت مستشار مهني متخصص في تحليل الشخصية المهنية ومساعدة الأشخاص في اختيار المسار المناسب."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 1500,
      temperature: 0.7
    });

    const content = response.choices[0].message.content;
    return JSON.parse(content);
  } catch (error) {
    console.error('Error generating Holland analysis:', error);
    
    // Fallback analysis based on primary type
    const fallbackAnalysis = {
      R: {
        majors: ["الهندسة الميكانيكية", "هندسة الكمبيوتر", "الزراعة", "الطب البيطري", "التقنية الطبية"],
        careers: ["مهندس ميكانيكي", "فني كمبيوتر", "مزارع", "طبيب بيطري", "فني طبي"],
        tips: ["طور مهاراتك العملية", "ابحث عن فرص التدريب العملي", "تعلم استخدام الأدوات والتقنيات الحديثة"]
      },
      I: {
        majors: ["الطب", "الهندسة", "الفيزياء", "الكيمياء", "علوم الكمبيوتر"],
        careers: ["طبيب", "مهندس", "عالم", "باحث", "محلل بيانات"],
        tips: ["طور مهارات البحث والتحليل", "اقرأ في مجالك باستمرار", "شارك في المشاريع البحثية"]
      },
      A: {
        majors: ["الفنون الجميلة", "التصميم الجرافيكي", "الإعلام", "الأدب", "الموسيقى"],
        careers: ["مصمم جرافيك", "كاتب", "موسيقي", "مصور", "مخرج"],
        tips: ["طور موهبتك الإبداعية", "بناء معرض أعمال قوي", "تواصل مع المبدعين الآخرين"]
      },
      S: {
        majors: ["علم النفس", "الخدمة الاجتماعية", "التربية", "التمريض", "الإرشاد"],
        careers: ["معلم", "أخصائي نفسي", "ممرض", "مرشد اجتماعي", "مدرب"],
        tips: ["طور مهارات التواصل", "تعلم كيفية مساعدة الآخرين", "اكتسب خبرة في العمل التطوعي"]
      },
      E: {
        majors: ["إدارة الأعمال", "التسويق", "القانون", "العلوم السياسية", "الاقتصاد"],
        careers: ["مدير", "محامي", "رجل أعمال", "مسوق", "سياسي"],
        tips: ["طور مهارات القيادة", "تعلم فن التفاوض", "ابني شبكة علاقات قوية"]
      },
      C: {
        majors: ["المحاسبة", "إدارة المكاتب", "نظم المعلومات", "الإحصاء", "المالية"],
        careers: ["محاسب", "مدير مكتب", "محلل مالي", "مدقق", "كاتب"],
        tips: ["طور مهارات التنظيم", "تعلم البرامج المكتبية", "اهتم بالتفاصيل والدقة"]
      }
    };

    return fallbackAnalysis[primaryType] || fallbackAnalysis['R'];
  }
};

module.exports = {
  generateHollandAnalysis
};